---
title: "testcontainers-scala ã§å¿«é©ãªã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["scala", "testcontainers"]
published: true
---

ã“ã®è¨˜äº‹ã¯ã€[3-shake Advent Calendar 2023](https://qiita.com/advent-calendar/2023/3-shake) ã® 22 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚


## ã¯ã˜ã‚ã«

ç§ã®æ‰€å±ã™ã‚‹æ ªå¼ä¼šç¤¾ã‚¹ãƒªãƒ¼ã‚·ã‚§ã‚¤ã‚¯ã§ã¯ã€Reckoner ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ã® SaaS ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

https://reckoner.io/

**ã€ŒSaaSã‚’ã¤ãªãã€‚æ¥­å‹™ãŒå¤‰ã‚ã‚‹ã€‚ãƒ“ã‚¸ãƒã‚¹ãŒé€²åŒ–ã™ã‚‹ã€‚ã€**

ç›´æ„Ÿçš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã§ã€å¤šç¨®å¤šæ§˜ãª SaaS ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã¤ãªãåˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ãƒ»ãƒ‡ãƒ¼ã‚¿ã®æ°‘ä¸»åŒ–ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

![img.png](/images/173ea1f829eafa/img.png)

## èª²é¡Œ

Reckoner ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»åŠ å·¥ãƒ»ä¿å­˜éƒ¨åˆ†ã‚’ Scala ã§å®Ÿè£…ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®é€£æºå…ˆã¨ã—ã¦ã€MySQL ã‚„ PostgreSQL ãªã©ã® RDBMS ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
é–‹ç™ºã®åˆæœŸæ®µéšã§ã¯ã“ã‚Œã‚‰ã® RDBMS ã‚’ç¹‹ãã“ã‚€ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®éš›ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«ç«‹ã¦ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã“ã¨ã‚„ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹éš›ã«é–‹ç™ºè€…ãŒå„ã€…ã®ç’°å¢ƒã§èªè¨¼æƒ…å ±ãªã©ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€è² æ‹…ãŒã‚ã‚Šã¾ã—ãŸã€‚

## è§£æ±ºç­–

ä¸Šè¨˜ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹æ‰‹æ®µã‚’æ¢ã—ã¦ã„ãŸã¨ã“ã‚ã€TestContainers ã¨ã„ã†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

https://testcontainers.com/

TestContainers ã¯ã€Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¸Šã«ç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆãŒã‚³ãƒ³ãƒ†ãƒŠã«ä¾å­˜ã—ã¦ã‚‹ã“ã¨ã‚’è¡¨ç¾ã—ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ãƒ»åœæ­¢ã¯è‡ªå‹•ã§è¡Œã‚ã‚Œã‚‹ã®ã§ã€é–‹ç™ºè€…ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ã‚³ãƒ³ãƒ†ãƒŠã®ç®¡ç†ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚

TestContainers ã¯æ§˜ã€…ãªè¨€èªã«å¯¾å¿œã—ã¦ãŠã‚Šã€Scala ã«å¯¾å¿œã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã—ã¦ testcontainers-scala ãŒã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã¯ã“ã® testcontainers-scala ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã”ç´¹ä»‹ã—ã¾ã™ã€‚

https://github.com/testcontainers/testcontainers-scala

## testcontainers-scala ã®ä½¿ã„æ–¹

### å‰ææ¡ä»¶

ä»Šå›ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®ç’°å¢ƒã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚

- ãƒã‚·ãƒ³: Macbook Pro (M1, 2020)
- OS: macOS Ventura (13)
- Docker: OrbStack 1.2.0
- Java: zulu-11.68.17
- ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«: sbt 1.9.7
- Scala: 2.13.12

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜ã®è¿½åŠ 

`build.sbt` ã« testcontainers-scala ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜ã‚’è¿½åŠ ã—ã¾ã™ã€‚  

```scala
lazy val my_project = (project in file("my_project"))
  .settings(
    libraryDependencies ++= Seq(
      "org.scalatest" %% "scalatest" % "3.2.17" % Test,
      "com.dimafeng" %% "testcontainers-scala-scalatest" % "0.41.0" % Test,
    )
  )
```

testcontainers-scala ã¯ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¦ãŠã‚Šã€Reckoner ã§ã¯ scalatest ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ä»Šå›ã¯ `testcontainers-scala-scalatest` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æº–å‚™

`my_project/src/test/scala` ã«é©å½“ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚

```scala
import org.scalatest.funsuite.AnyFunSuite

class ExampleSpec extends AnyFunSuite {

  test("TODO") {
    ???
  }
}
```

æ¬¡ã« TestContainers ã‚’ä½¿ã†æº–å‚™ã‚’ã—ã¾ã™ã€‚  
`ExampleSpec` ã« `TestContainerForAll` ãƒˆãƒ¬ã‚¤ãƒˆã‚’ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã—ã¾ã™ã€‚

```scala
import com.dimafeng.testcontainers.ContainerDef
import com.dimafeng.testcontainers.scalatest.TestContainersForAll
import org.scalatest.funsuite.AnyFunSuite

class ExampleSpec extends AnyFunSuite with TestContainersForAll {

  type Containers = ???

  def startContainers(): Containers = ???

  test("TODO") {
    ???
  }
}
```

`TestContainerForAll` ã‚’ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®é–‹å§‹æ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•æ™‚ã€çµ‚äº†æ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
æ¬¡ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«èµ·å‹•ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

### å˜ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

ä»Šå›ã¯ nginx ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ã€HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚
å®Œæˆå½¢ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```scala
import java.net.http.HttpClient
import java.net.http.HttpResponse.BodyHandlers

import com.dimafeng.testcontainers.GenericContainer
import com.dimafeng.testcontainers.scalatest.TestContainersForAll
import org.scalatest.funsuite.AnyFunSuite
import org.testcontainers.containers.wait.strategy.Wait

class ExampleSpec extends AnyFunSuite with TestContainersForAll {

  type Containers = GenericContainer

  // ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Ÿè¡Œæ™‚ã« nginx ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã™ã‚‹ã‚ˆã†ã«è¨­å®š
  def startContainers(): Containers = {
    val container = GenericContainer(
      dockerImage = "nginx:latest",
      exposedPorts = Seq(80),                             // ã‚³ãƒ³ãƒ†ãƒŠå´ã®ãƒãƒ¼ãƒˆç•ªå·
      waitStrategy = Wait.forHttp("/").forStatusCode(200) // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒ 200 ã‚’è¿”ã™ã¾ã§å¾…æ©Ÿ
    )
    container.start() // ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
    container
  }

  test("nginx ã‚³ãƒ³ãƒ†ãƒŠã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã‚‹ã“ã¨") {
    // ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã†ãƒ†ã‚¹ãƒˆã¯ withContainers å†…ã§å®Ÿè¡Œã™ã‚‹
    withContainers { case nginx =>
      val httpClient = HttpClient.newHttpClient()
      val request = java.net.http.HttpRequest
        .newBuilder()
        // `host` ãƒ¡ã‚½ãƒƒãƒ‰ã§å¯¾è±¡ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ã‚¹ãƒˆåã‚’å–å¾—
        // `mappedPort` ãƒ¡ã‚½ãƒƒãƒ‰ã§å¯¾è±¡ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆç•ªå·ã‚’å–å¾—
        .uri(java.net.URI.create(s"http://${nginx.host}:${nginx.mappedPort(80)}/"))
        .build()
      val response = httpClient.send(request, BodyHandlers.ofString())
      assert(response.body() contains "<title>Welcome to nginx!</title>")
    }
  }
}
```

`startContainers` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
`GenericContainer` ã‚’ä½¿ç”¨ã—ã¦ nginx ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ã€‚[^1]
`waitStrategy` ã¯ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™ã€‚
ä»Šå›ã¯ nginx ãŒèµ·å‹•ã—ã¦ã‹ã‚‰ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚[^2]

[^1]: [testcontainers-scala ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…](https://github.com/testcontainers/testcontainers-scala/blob/master/docs/src/main/tut/usage.md) ã§ã¯ `GenericContaier.Def` ã‚’ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ãŒã€`GenericContainer` ã‚’ç›´ã«ä½¿ã†ã»ã†ãŒãƒ©ãƒƒãƒ—ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚ã‚‹ TestContainers Java ã®é«˜åº¦ãª API ã‚’ä½¿ã„ã‚„ã™ã„ãŸã‚ã“ã®å½¢ã«ã—ã¦ã„ã¾ã™ã€‚
[^2]: ãã®ä»–ã® `waitStrategy` ã«ã¤ã„ã¦ã¯ [TestContainers Java ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://java.testcontainers.org/features/startup_and_waits/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§èµ·å‹•ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ `withContainers` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚
`withContainers` ãƒ¡ã‚½ãƒƒãƒ‰ã®é«˜éšé–¢æ•°ã®å¼•æ•°ã‹ã‚‰ã€èµ·å‹•ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
`nginx.host` ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ›ã‚¹ãƒˆåã€`nginx.mappedPort(80)` ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆç•ªå·ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

:::message

TestContainers ã¯ `exposedPorts` ã§æŒ‡å®šã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆç•ªå·ã‚’ãƒ›ã‚¹ãƒˆå´ã®ãƒ©ãƒ³ãƒ€ãƒ ãªç©ºããƒãƒ¼ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ç›´æ¥ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆç•ªå·ã‚’æŒ‡å®šã›ãšã€ `mappedPort` ã‚’ä½¿ã†ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã« `docker ps` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸçµæœã§ã™ã€‚
ãƒ›ã‚¹ãƒˆå´ãƒãƒ¼ãƒˆã¯ `32773` ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ docker ps
CONTAINER ID   IMAGE        ...(çœç•¥)... PORTS                                  
5bc870850f32   nginx:latest             0.0.0.0:32773->80/tcp, :::32773->80/tcp
```

:::

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã€nginx ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¾—ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```
20:07:12.362 [pool-92-thread-5] INFO  tc.nginx:latest - Creating container for image: nginx:latest
20:07:12.417 [pool-92-thread-5] INFO  tc.nginx:latest - Container nginx:latest is starting: 0526a4a0bd818cf43bfc88fa6f6f8e7bf1e21730ad8b78002f600aa3fdf2e468
20:07:12.868 [pool-92-thread-5] INFO  tc.nginx:latest - Container nginx:latest started in PT0.50651S
20:07:13.133 [pool-92-thread-5] DEBUG o.t.utility.ResourceReaper - Removed container and associated volume(s): nginx:latest
[info] ExampleSpec:
[info] - nginx ã‚³ãƒ³ãƒ†ãƒŠã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã‚‹ã“ã¨
[info] Run completed in 6 seconds, 891 milliseconds.
[info] Total number of tests run: 1
[info] Suites: completed 1, aborted 0
[info] Tests: succeeded 1, failed 0, canceled 0, ignored 0, pending 0
[info] All tests passed.
```

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•

MySQL ã‚„ PostgreSQL ã¨ã„ã£ãŸ RDBMS ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹éš›ã¯ã€testcontainers-scala ãŒæä¾›ã—ã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã¨ã‚ˆã‚Šä¾¿åˆ©ã§ã™ã€‚

https://github.com/testcontainers/testcontainers-scala/blob/master/docs/src/main/tut/setup.md#modules

`testcontainers-scala-postgresql` ã‚’ä½¿ç”¨ã—ã¦ PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã†ã¨ã—ã¾ã™ã€‚
`build.sbt` ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¾å­˜ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```scala
lazy val my_project = (project in file("my_project"))
  .settings(
    libraryDependencies ++= Seq(
      "org.scalatest" %% "scalatest" % "3.2.17" % Test,
      "com.dimafeng" %% "testcontainers-scala-scalatest"  % "0.41.0" % Test,
      "com.dimafeng" %% "testcontainers-scala-postgresql" % "0.41.0" % Test,
    )
  )
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚

```scala
import com.dimafeng.testcontainers.PostgreSQLContainer
import com.dimafeng.testcontainers.scalatest.TestContainersForAll
import org.scalatest.funsuite.AnyFunSuite
import org.testcontainers.utility.DockerImageName

class ExampleSpec extends AnyFunSuite with TestContainersForAll {

  type Containers = PostgreSQLContainer

  def startContainers(): Containers = {
    val postgres = PostgreSQLContainer(dockerImageNameOverride = DockerImageName.parse("postgres:15"))
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    postgres.container.withInitScript("init_it.sql")
    postgres.container.start()
    postgres
  }

  test("postgres") {
    withContainers { case postgres =>
      println(s"JDBC URL: ${postgres.jdbcUrl}")
      println(s"Username: ${postgres.username}")
      println(s"Password: ${postgres.password}")

      // å®Ÿéš›ã«ã¯ã“ã“ã§ DB ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    }
  }
}
```

`PostgreSQLContainer` ã‚’ä½¿ç”¨ã—ã¦ PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠã®å®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹éš›ã«ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãªã©ãŒå¿…è¦ã«ãªã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚
TestContainers ã§ã¯ `withInitScript` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã‚‹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚[^4]
`my_project/src/test/resources/init_it.sql` ã«åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é…ç½®ã—ã¾ã™ã€‚

[^4]: `postgres.container` ã§ TestContainers Java ã® API ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚ç§ã®çŸ¥ã‚‹é™ã‚Š testcontainers-scala ã® `v0.41.0` æ™‚ç‚¹ã§ã¯åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æŒ‡å®šã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ãªã„ãŸã‚ã“ã®ã‚ˆã†ãªå½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

```sql
create table employee
(
    id         bigint primary key,
    name       varchar(255) not null,
    section_id bigint       not null
);

insert into employee
values (1, 'aaa', 100),
       (2, 'bbb', 100),
       (3, 'ccc', 200),
       (4, 'ddd', 200),
       (5, 'eee', 300),
       (6, 'fff', 300);
```

PostgreSQL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã® JDBC URL ã‚„èªè¨¼æƒ…å ±ã¯ `postgres.jdbcUrl` ã‚„ `postgres.username` ãªã©ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã€åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€TestContainers ãŒè¨­å®šã—ãŸ JDBC URL ã‚„èªè¨¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```
21:21:18.930 [pool-100-thread-1] INFO  tc.postgres:15 - Container postgres:15 started in PT16.299357S
21:21:18.932 [pool-100-thread-1] INFO  tc.postgres:15 - Container is started (JDBC URL: jdbc:postgresql://localhost:32777/test?loggerLevel=OFF)
21:21:18.954 [pool-100-thread-1] INFO  org.testcontainers.ext.ScriptUtils - Executing database script from init_it.sql
21:21:18.971 [pool-100-thread-1] DEBUG tc.postgres:15 - Trying to create JDBC connection using org.postgresql.Driver to jdbc:postgresql://localhost:32777/test?loggerLevel=OFF with properties: {password=test, user=test}
21:21:19.150 [pool-100-thread-1] DEBUG o.t.jdbc.JdbcDatabaseDelegate - false returned as updateCount for SQL: create table employee ( id bigint primary key, name varchar(255) not null, section_id bigint not null )
21:21:19.151 [pool-100-thread-1] DEBUG o.t.jdbc.JdbcDatabaseDelegate - false returned as updateCount for SQL: insert into employee values (1, 'aaa', 100), (2, 'bbb', 100), (3, 'ccc', 200), (4, 'ddd', 200), (5, 'eee', 300), (6, 'fff', 300)
21:21:19.157 [pool-100-thread-1] INFO  org.testcontainers.ext.ScriptUtils - Executed database script from init_it.sql in 203 ms.

...

JDBC URL: jdbc:postgresql://localhost:32777/test?loggerLevel=OFF
Username: test
Password: test
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

![img.png](/images/173ea1f829eafa/img2.png)

## ã¾ã¨ã‚

ã‚‚ã†å°‘ã—è¸ã¿è¾¼ã‚“ã å†…å®¹ã«ã¤ã„ã¦æ›¸ã“ã†ã¨æ€ã„ã¾ã—ãŸãŒã€ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœŸæ—¥ã«é–“ã«åˆã‚ãã†ãªã®ã§ã“ã“ã¾ã§â€¦ã¿ãªã•ã‚“ã¯è¨˜äº‹ã‚’æ›¸ãã®ã¯è¨ˆç”»çš„ã«â€¦

TestContainers ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€é–‹ç™ºè€…ã¯ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«æ™‚é–“ã‚’ã‹ã‘ã‚‹ã“ã¨ãªãå®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã¾ãŸã€å®Ÿéš›ã«ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç«‹ã¦ã‚‹å¿…è¦ã‚‚ãªããªã£ãŸã®ã§ã€ãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ã—ã¦ã„ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯åœæ­¢ã—ã€ã‚³ã‚¹ãƒˆå‰Šæ¸›ã«ã‚‚ã¤ãªãŒã‚Šã¾ã—ãŸã€‚

TestContainers ã‚’ä½¿ã£ã¦å¿«é©ãªã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿç¾ã—ã¾ã—ã‚‡ã†ï¼

## ãŠã‚ã‚Šã«

Reckoner ã§ã¯ Scala ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ï¼

æ ªå¼ä¼šç¤¾ã‚¹ãƒªãƒ¼ã‚·ã‚§ã‚¤ã‚¯ã®æ¡ç”¨æƒ…å ±ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚

https://jobs-3-shake.com/

https://hrmos.co/pages/threeshake/jobs?category=1661609359626186756
